name: test package and install dependencies

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BUILD_NUMBER: ${{ github.run_number }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies and pull nginx
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"Step: Install dependencies and pull nginx - Started"}' $SLACK_WEBHOOK
          {
            sudo docker image pull nginx:latest
            sudo apt-get update && sudo apt-get install -y makeself shellcheck
          } && curl -X POST -H 'Content-type: application/json' --data '{"text":"Step: Install dependencies and pull nginx - ‚úÖ Success"}' $SLACK_WEBHOOK \
            || curl -X POST -H 'Content-type: application/json' --data '{"text":"Step: Install dependencies and pull nginx - ‚ùå Failed"}' $SLACK_WEBHOOK

      - name: Check installer script with ShellCheck
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"Step: ShellCheck - Started"}' $SLACK_WEBHOOK
          {
            shellcheck -x ./installer.sh
          } && curl -X POST -H 'Content-type: application/json' --data '{"text":"Step: ShellCheck - ‚úÖ Success"}' $SLACK_WEBHOOK \
            || curl -X POST -H 'Content-type: application/json' --data '{"text":"Step: ShellCheck - ‚ùå Failed"}' $SLACK_WEBHOOK

      - name: Package the installer
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"Step: Package installer - Started"}' $SLACK_WEBHOOK
          {
            makeself --tar-extra "--exclude=.git --exclude=.github" . installer_${BUILD_NUMBER} "My app parsing" ./install.sh
          } && curl -X POST -H 'Content-type: application/json' --data '{"text":"Step: Package installer - ‚úÖ Success"}' $SLACK_WEBHOOK \
            || curl -X POST -H 'Content-type: application/json' --data '{"text":"Step: Package installer - ‚ùå Failed"}' $SLACK_WEBHOOK

      - name: Final pipeline result
        if: ${{ success() }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"üöÄ Pipeline completed successfully!"}' $SLACK_WEBHOOK

      - name: Final pipeline failure
        if: ${{ failure() }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"üî• Pipeline failed!"}' $SLACK_WEBHOOK
